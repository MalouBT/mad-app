
<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mad App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Lexend', sans-serif;
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "react-router-dom": "https://esm.sh/react-router-dom@6.24.1"
      }
    }
    </script>
    <!-- Add Babel to transpile JSX/TSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#0f2d32] text-[#ffffff]">
    <div id="root"></div>
    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useMemo, ChangeEvent, FormEvent, createContext, useReducer, ReactNode, useContext } from 'react';
        import ReactDOM from 'react-dom/client';
        import { HashRouter, Routes, Route, Link, useNavigate, useParams, useLocation } from 'react-router-dom';

        // --- TYPES --- //
        interface Ingredient {
          id: string;
          name: string;
        }

        interface Rating {
          userId: string;
          score: number; // 0-10
        }

        interface Recipe {
          id: string;
          title: string;
          imageUrls: string[];
          prepTimeInMinutes: number;
          ingredients: Ingredient[];
          instructions: string;
          notes?: string;
          categories: string[]; // array of category ids
          ratings: Rating[];
          authorId: string;
          createdAt: string;
        }

        interface User {
          id: string;
          name: string;
          imageUrl: string;
          favoriteRecipeIds: string[];
        }

        interface Category {
          id: string;
          name: string;
        }

        interface AppState {
          users: User[];
          recipes: Recipe[];
          categories: Category[];
          currentUser: User | null;
        }

        type Action =
          | { type: 'LOAD_STATE'; payload: AppState }
          | { type: 'SET_CURRENT_USER'; payload: User }
          | { type: 'ADD_RECIPE'; payload: Recipe }
          | { type: 'UPDATE_RECIPE'; payload: Recipe }
          | { type: 'ADD_USER'; payload: User }
          | { type: 'ADD_CATEGORY'; payload: Category }
          | { type: 'DELETE_CATEGORY'; payload: string }
          | { type: 'DELETE_USER'; payload: string }
          | { type: 'TOGGLE_FAVORITE'; payload: { userId: string; recipeId: string } }
          | { type: 'RATE_RECIPE'; payload: { userId: string; recipeId: string; score: number } };

        interface AppContextType {
          state: AppState;
          dispatch: React.Dispatch<Action>;
          getAverageRating: (recipeId: string) => number;
        }


        // --- CONTEXT --- //
        const initialUsers: User[] = [
          { id: 'user-1', name: 'Mads', imageUrl: 'https://picsum.photos/seed/mads/100/100', favoriteRecipeIds: ['recipe-1'] },
          { id: 'user-2', name: 'Stine', imageUrl: 'https://picsum.photos/seed/stine/100/100', favoriteRecipeIds: ['recipe-2', 'recipe-3'] },
        ];

        const initialCategories: Category[] = [
          { id: 'cat-1', name: 'Aftensmad' },
          { id: 'cat-2', name: 'Frokost' },
          { id: 'cat-3', name: 'Kage' },
          { id: 'cat-4', name: 'Bagning' },
          { id: 'cat-5', name: 'Hurtigt' },
        ];

        const initialRecipes: Recipe[] = [
          {
            id: 'recipe-1',
            title: 'Klassisk Lasagne',
            imageUrls: ['https://picsum.photos/seed/lasagne/600/400'],
            prepTimeInMinutes: 90,
            ingredients: [
              { id: 'ing-1-1', name: '500g hakket oksekød' },
              { id: 'ing-1-2', name: '1 stort løg' },
              { id: 'ing-1-3', name: '2 fed hvidløg' },
              { id: 'ing-1-4', name: '1 dåse hakkede tomater' },
              { id: 'ing-1-5', name: 'Lasagneplader' },
              { id: 'ing-1-6', name: 'Bechamelsauce' },
              { id: 'ing-1-7', name: 'Revet ost' },
            ],
            instructions: '1. Svits kød, løg og hvidløg. 2. Tilsæt tomater og lad det simre. 3. Saml lasagnen i lag. 4. Bag i ovnen i 45 min ved 200°C.',
            notes: 'Server med en frisk salat.',
            categories: ['cat-1'],
            ratings: [{ userId: 'user-1', score: 9 }, { userId: 'user-2', score: 8 }],
            authorId: 'user-1',
            createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 2).toISOString(),
          },
          {
            id: 'recipe-2',
            title: 'Chokoladekage',
            imageUrls: ['https://picsum.photos/seed/kage/600/400'],
            prepTimeInMinutes: 45,
            ingredients: [
              { id: 'ing-2-1', name: '200g mørk chokolade' },
              { id: 'ing-2-2', name: '200g smør' },
              { id: 'ing-2-3', name: '250g sukker' },
              { id: 'ing-2-4', name: '4 æg' },
              { id: 'ing-2-5', name: '150g hvedemel' },
            ],
            instructions: '1. Smelt chokolade og smør. 2. Pisk æg og sukker. 3. Bland det hele sammen. 4. Bag i 30 min ved 180°C.',
            categories: ['cat-3', 'cat-4'],
            ratings: [{ userId: 'user-2', score: 10 }],
            authorId: 'user-2',
            createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 5).toISOString(),
          },
           {
            id: 'recipe-3',
            title: 'Avocado Toast',
            imageUrls: ['https://picsum.photos/seed/avocado/600/400'],
            prepTimeInMinutes: 10,
            ingredients: [
              { id: 'ing-3-1', name: '2 skiver rugbrød' },
              { id: 'ing-3-2', name: '1 moden avocado' },
              { id: 'ing-3-3', name: 'Citronsaft' },
              { id: 'ing-3-4', name: 'Salt og peber' },
              { id: 'ing-3-5', name: 'Chiliflager' },
            ],
            instructions: '1. Rist brødet. 2. Mos avocado med en gaffel og smag til med citron, salt og peber. 3. Fordel på brødet og drys med chiliflager.',
            categories: ['cat-2', 'cat-5'],
            ratings: [{ userId: 'user-1', score: 7 }, { userId: 'user-2', score: 8 }],
            authorId: 'user-2',
            createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 1).toISOString(),
          },
        ];

        const initialState: AppState = {
          users: initialUsers,
          recipes: initialRecipes,
          categories: initialCategories,
          currentUser: null,
        };

        const AppContext = createContext<AppContextType | undefined>(undefined);

        const appReducer = (state: AppState, action: Action): AppState => {
          switch (action.type) {
            case 'LOAD_STATE':
                return action.payload;
            case 'SET_CURRENT_USER':
              return { ...state, currentUser: action.payload };
            case 'ADD_RECIPE':
              return { ...state, recipes: [action.payload, ...state.recipes] };
            case 'UPDATE_RECIPE':
              return {
                ...state,
                recipes: state.recipes.map((r) => (r.id === action.payload.id ? action.payload : r)),
              };
            case 'ADD_USER':
              return { ...state, users: [...state.users, action.payload] };
            case 'DELETE_USER':
              return { ...state, users: state.users.filter(u => u.id !== action.payload) };
            case 'ADD_CATEGORY':
                return { ...state, categories: [...state.categories, action.payload] };
            case 'DELETE_CATEGORY':
                return { ...state, categories: state.categories.filter(c => c.id !== action.payload) };
            case 'TOGGLE_FAVORITE': {
              const { userId, recipeId } = action.payload;
              return {
                ...state,
                users: state.users.map((user) => {
                  if (user.id === userId) {
                    const isFavorite = user.favoriteRecipeIds.includes(recipeId);
                    const favoriteRecipeIds = isFavorite
                      ? user.favoriteRecipeIds.filter((id) => id !== recipeId)
                      : [...user.favoriteRecipeIds, recipeId];
                    return { ...user, favoriteRecipeIds };
                  }
                  return user;
                }),
              };
            }
            case 'RATE_RECIPE': {
              const { userId, recipeId, score } = action.payload;
              return {
                ...state,
                recipes: state.recipes.map((recipe) => {
                  if (recipe.id === recipeId) {
                    const existingRatingIndex = recipe.ratings.findIndex((r) => r.userId === userId);
                    const newRatings = [...recipe.ratings];
                    if (existingRatingIndex > -1) {
                      newRatings[existingRatingIndex] = { userId, score };
                    } else {
                      newRatings.push({ userId, score });
                    }
                    return { ...recipe, ratings: newRatings };
                  }
                  return recipe;
                }),
              };
            }
            default:
              return state;
          }
        };

        const AppProvider = ({ children }: { children: ReactNode }) => {
          const [state, dispatch] = useReducer(appReducer, initialState);

          useEffect(() => {
            try {
              const storedState = localStorage.getItem('madApp_state');
              if (storedState) {
                const parsedState = JSON.parse(storedState);
                dispatch({ type: 'LOAD_STATE', payload: parsedState });
              } else {
                // On first load, set a default user
                if (initialUsers.length > 0) {
                    dispatch({ type: 'SET_CURRENT_USER', payload: initialUsers[0] });
                }
              }
            } catch (error) {
              console.error("Could not load state from localStorage", error);
            }
          }, []);

          useEffect(() => {
            try {
              localStorage.setItem('madApp_state', JSON.stringify(state));
            } catch (error) {
              console.error("Could not save state to localStorage", error);
            }
          }, [state]);
          
          const getAverageRating = (recipeId: string): number => {
            const recipe = state.recipes.find(r => r.id === recipeId);
            if (!recipe || recipe.ratings.length === 0) return 0;
            const sum = recipe.ratings.reduce((acc, rating) => acc + rating.score, 0);
            return Math.round((sum / recipe.ratings.length) * 10) / 10;
          };

          return (
            <AppContext.Provider value={{ state, dispatch, getAverageRating }}>
              {children}
            </AppContext.Provider>
          );
        };

        const useAppContext = (): AppContextType => {
          const context = useContext(AppContext);
          if (context === undefined) {
            throw new Error('useAppContext must be used within an AppProvider');
          }
          return context;
        };

        // --- COMPONENTS AND PAGES --- //
        const HeartIcon = ({ className }: { className?: string }) => (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className || 'w-6 h-6'}>
            <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-1.344-.688 18.25 18.25 0 0 1-4.433-3.084 9.696 9.696 0 0 1-2.01-3.955C2.04 12.033 2 11.026 2 10.027c0-1.85.589-3.595 1.702-4.912C4.814 3.8 6.546 3 8.441 3c1.742 0 3.32.712 4.493 2.005.154.168.29.345.413.531a.05.05 0 0 0 .082 0l.012-.018.012-.018c.123-.186.259-.363.413-.531C14.717 3.712 16.295 3 18.037 3c1.895 0 3.628.8 4.74 2.115C23.41 6.432 24 8.177 24 10.027c0 1.002-.04 2.006-.294 3.149a9.696 9.696 0 0 1-2.01 3.955 18.25 18.25 0 0 1-4.433 3.084 15.247 15.247 0 0 1-1.344.688l-.022.012-.007.003-.002.001a.752.752 0 0 1-.67-.002l-.003-.001Z" />
          </svg>
        );
        const StarIcon = ({ className, filled, onMouseEnter, onClick }: { className?: string; filled: boolean; onMouseEnter?: () => void; onClick?: () => void; }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill={filled ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth={1.5} className={className || 'w-6 h-6'} onMouseEnter={onMouseEnter} onClick={onClick}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" />
            </svg>
        );
        const ClockIcon = ({ className }: { className?: string }) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className || 'w-6 h-6'}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
        );
        const ArrowUpIcon = ({ className }: { className?: string }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className || 'w-6 h-6'}>
                <path strokeLinecap="round" strokeLinejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
            </svg>
        );
        const ArrowDownIcon = ({ className }: { className?: string }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className || 'w-6 h-6'}>
                <path strokeLinecap="round" strokeLinejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
        );
        const TrashIcon = ({ className }: { className?: string }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className || 'w-6 h-6'}>
                <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.134H8.09a2.09 2.09 0 0 0-2.09 2.134v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>
        );
        const PencilIcon = ({ className }: { className?: string }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className || 'w-6 h-6'}>
                <path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
            </svg>
        );
        const PlusIcon = ({ className }: { className?: string }) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className || 'w-6 h-6'}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
        );

        const RecipeCard = ({ recipe }: { recipe: Recipe }) => {
            const { getAverageRating } = useAppContext();
            const averageRating = getAverageRating(recipe.id);

            return (
                <Link to={`/recipe/${recipe.id}`} className="block bg-[#1a3e44] rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-shadow duration-300 transform hover:-translate-y-1">
                    <div className="relative">
                        <img src={recipe.imageUrls[0]} alt={recipe.title} className="w-full h-48 object-cover"/>
                        <div className="absolute top-2 right-2 bg-[#0f2d32] bg-opacity-70 p-2 rounded-lg flex items-center gap-1">
                            <StarIcon className="w-5 h-5 text-[#75fb9e]" filled={true}/>
                            <span className="font-bold text-white">{averageRating.toFixed(1)}</span>
                        </div>
                         <div className="absolute bottom-0 left-0 bg-[#0f2d32] bg-opacity-70 p-2 rounded-tr-lg flex items-center gap-1">
                            <ClockIcon className="w-5 h-5 text-[#75fb9e]"/>
                            <span className="text-sm text-white">{recipe.prepTimeInMinutes} min</span>
                        </div>
                    </div>
                    <div className="p-4">
                        <h3 className="font-bold text-lg truncate text-white">{recipe.title}</h3>
                    </div>
                </Link>
            );
        };

        const UserSelectionHeader = () => {
            const { state, dispatch } = useAppContext();
            const { users, currentUser } = state;

            const handleUserChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
                const selectedUser = users.find(u => u.id === e.target.value);
                if (selectedUser) {
                    dispatch({ type: 'SET_CURRENT_USER', payload: selectedUser });
                }
            };

            return (
                <div className="bg-[#1a3e44] p-2 flex justify-between items-center sticky top-0 z-20">
                    <Link to="/" className="text-2xl font-bold text-[#75fb9e]">Mad App</Link>
                    {currentUser && (
                        <div className="flex items-center gap-2">
                            <span className="text-sm">Logget ind som:</span>
                             <select 
                                value={currentUser.id} 
                                onChange={handleUserChange}
                                className="bg-[#0f2d32] border border-[#75fb9e] rounded-md p-1 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"
                            >
                                {users.map(user => (
                                    <option key={user.id} value={user.id}>{user.name}</option>
                                ))}
                            </select>
                        </div>
                    )}
                </div>
            );
        };


        const WelcomePage = () => {
            const { state, dispatch } = useAppContext();
            const navigate = useNavigate();

            const selectUserAndGo = (user: User) => {
                dispatch({ type: 'SET_CURRENT_USER', payload: user });
                navigate(`/user/${user.id}`);
            };

            return (
                <div className="p-4 sm:p-8 text-center flex flex-col items-center justify-center min-h-screen">
                    <h1 className="text-5xl font-bold text-white mb-4">Velkommen til Mad App</h1>
                    <p className="text-lg text-gray-300 mb-12">Del, opdag og nyd fantastiske opskrifter.</p>
                    
                    <div className="flex flex-col sm:flex-row gap-6 mb-16">
                        <Link to="/create" className="bg-[#75fb9e] text-[#0f2d32] font-bold py-4 px-8 rounded-lg text-xl hover:bg-white transition-colors duration-300">Opret Opskrift</Link>
                        <Link to="/recipes" className="bg-transparent border-2 border-[#75fb9e] text-[#75fb9e] font-bold py-4 px-8 rounded-lg text-xl hover:bg-[#75fb9e] hover:text-[#0f2d32] transition-colors duration-300">Hvad skal vi lave?</Link>
                    </div>

                    <div className="w-full max-w-2xl">
                        <h2 className="text-2xl font-semibold text-white mb-6">Brugere</h2>
                        <div className="flex justify-center gap-6 flex-wrap">
                            {state.users.map(user => (
                                <div key={user.id} onClick={() => selectUserAndGo(user)} className="cursor-pointer group flex flex-col items-center gap-2">
                                    <img src={user.imageUrl} alt={user.name} className="w-20 h-20 rounded-full border-4 border-[#1a3e44] group-hover:border-[#75fb9e] transition-all duration-300"/>
                                    <span className="text-white group-hover:text-[#75fb9e] font-medium">{user.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const FindRecipePage = ({ mode = 'all' }: { mode?: 'all' | 'favorites' }) => {
            const { state } = useAppContext();
            const { recipes, categories, currentUser } = state;
            const [visibleCount, setVisibleCount] = useState(20);
            const [categoryFilter, setCategoryFilter] = useState<string>('');
            const [timeFilter, setTimeFilter] = useState<string>('');

            const filteredRecipes = useMemo(() => {
                let recipesToFilter = recipes;
                if (mode === 'favorites') {
                    if (!currentUser) return [];
                    recipesToFilter = recipes.filter(r => currentUser.favoriteRecipeIds.includes(r.id));
                }
                
                return recipesToFilter
                    .filter(r => categoryFilter ? r.categories.includes(categoryFilter) : true)
                    .filter(r => timeFilter ? r.prepTimeInMinutes <= parseInt(timeFilter) : true)
                    .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
            }, [recipes, categoryFilter, timeFilter, mode, currentUser]);

            useEffect(() => {
                const handleScroll = () => {
                    if (window.innerHeight + document.documentElement.scrollTop >= document.documentElement.offsetHeight - 200) {
                        setVisibleCount(prevCount => prevCount + 20);
                    }
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            return (
                <div className="p-4 sm:p-6">
                    <div className="mb-6 bg-[#1a3e44] p-4 rounded-lg flex flex-col sm:flex-row gap-4 items-center">
                        <h2 className="text-xl font-bold text-white flex-shrink-0">{mode === 'favorites' ? 'Mine Favoritter' : 'Find Opskrift'}</h2>
                        <div className="flex-grow w-full sm:w-auto flex flex-col sm:flex-row gap-4">
                            <select value={categoryFilter} onChange={e => setCategoryFilter(e.target.value)} className="w-full bg-[#0f2d32] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none">
                                <option value="">Alle Kategorier</option>
                                {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.name}</option>)}
                            </select>
                            <select value={timeFilter} onChange={e => setTimeFilter(e.target.value)} className="w-full bg-[#0f2d32] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none">
                                <option value="">Al Tid</option>
                                <option value="15">Under 15 min</option>
                                <option value="30">Under 30 min</option>
                                <option value="60">Under 60 min</option>
                                <option value="90">Under 90 min</option>
                            </select>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        {filteredRecipes.slice(0, visibleCount).map(recipe => (
                            <RecipeCard key={recipe.id} recipe={recipe} />
                        ))}
                    </div>
                    {filteredRecipes.length === 0 && <p className="text-center col-span-full text-gray-400 mt-8">Ingen opskrifter fundet.</p>}
                </div>
            );
        };

        const RecipeDetailPage = () => {
            const { id } = useParams<{ id: string }>();
            const { state, dispatch, getAverageRating } = useAppContext();
            const navigate = useNavigate();
            const [hoverRating, setHoverRating] = useState(0);

            const recipe = state.recipes.find(r => r.id === id);
            
            if (!state.currentUser || !recipe) {
                return <div className="p-8 text-center">Opskrift ikke fundet. <Link to="/recipes" className="text-[#75fb9e]">Gå tilbage</Link></div>;
            }
            
            const { currentUser } = state;
            const averageRating = getAverageRating(recipe.id);
            const userRating = recipe.ratings.find(r => r.userId === currentUser.id)?.score || 0;
            const isFavorite = currentUser.favoriteRecipeIds.includes(recipe.id);
            const author = state.users.find(u => u.id === recipe.authorId);

            const handleFavorite = () => {
                dispatch({ type: 'TOGGLE_FAVORITE', payload: { userId: currentUser.id, recipeId: recipe.id } });
            };

            const handleRating = (score: number) => {
                dispatch({ type: 'RATE_RECIPE', payload: { userId: currentUser.id, recipeId: recipe.id, score } });
            };

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6">
                    <div className="relative mb-6 rounded-lg overflow-hidden">
                        <img src={recipe.imageUrls[0]} alt={recipe.title} className="w-full h-64 md:h-96 object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                        <button onClick={handleFavorite} className="absolute top-4 right-4 p-3 bg-white/20 backdrop-blur-sm rounded-full text-white hover:text-red-500 transition-colors duration-300">
                            <HeartIcon className={`w-8 h-8 ${isFavorite ? 'text-red-500' : ''}`} />
                        </button>
                         <div className="absolute bottom-4 left-4">
                            <h1 className="text-4xl md:text-5xl font-bold text-white drop-shadow-lg">{recipe.title}</h1>
                            {author && <p className="text-gray-200">af {author.name}</p>}
                        </div>
                    </div>

                    <div className="bg-[#1a3e44] p-4 rounded-lg mb-6 flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center gap-2">
                            <StarIcon className="w-6 h-6 text-[#75fb9e]" filled={true}/>
                            <span className="text-xl font-bold">{averageRating.toFixed(1)}</span>
                            <span className="text-gray-400">({recipe.ratings.length} bedømmelser)</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <ClockIcon className="w-6 h-6 text-[#75fb9e]"/>
                            <span className="text-xl font-bold">{recipe.prepTimeInMinutes} min</span>
                        </div>
                        <button onClick={() => navigate(`/edit/${recipe.id}`)} className="flex items-center gap-2 bg-[#0f2d32] hover:bg-[#2a5a63] text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            <PencilIcon className="w-5 h-5"/>
                            <span>Rediger</span>
                        </button>
                    </div>

                    <div className="mb-8">
                        <h3 className="text-2xl font-semibold mb-3 text-[#75fb9e]">Giv din bedømmelse</h3>
                        <div className="flex items-center gap-1" onMouseLeave={() => setHoverRating(0)}>
                            {[...Array(10)].map((_, i) => (
                                <StarIcon 
                                    key={i} 
                                    className="w-8 h-8 cursor-pointer text-[#75fb9e]"
                                    filled={(hoverRating || userRating) > i}
                                    onMouseEnter={() => setHoverRating(i + 1)}
                                    onClick={() => handleRating(i + 1)}
                                />
                            ))}
                            <span className="ml-4 text-xl font-bold">{(hoverRating || userRating)} / 10</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div className="md:col-span-1">
                            <h2 className="text-2xl font-semibold mb-4 text-[#75fb9e]">Ingredienser</h2>
                            <ul className="space-y-2">
                                {recipe.ingredients.map(ing => (
                                    <li key={ing.id} className="p-3 bg-[#1a3e44] rounded-md">{ing.name}</li>
                                ))}
                            </ul>
                        </div>
                        <div className="md:col-span-2">
                            <h2 className="text-2xl font-semibold mb-4 text-[#75fb9e]">Fremgangsmåde</h2>
                            <div className="prose prose-invert max-w-none whitespace-pre-line text-gray-300">
                                {recipe.instructions}
                            </div>
                            {recipe.notes && (
                                <>
                                    <h2 className="text-2xl font-semibold mt-8 mb-4 text-[#75fb9e]">Noter</h2>
                                    <p className="text-gray-300 italic">{recipe.notes}</p>
                                </>
                            )}
                        </div>
                    </div>

                    <button onClick={() => navigate(-1)} className="mt-8 bg-[#75fb9e] text-[#0f2d32] font-bold py-2 px-6 rounded-lg hover:bg-white transition-colors">
                        Tilbage
                    </button>
                </div>
            );
        };

        const RecipeFormPage = () => {
            const { id } = useParams<{ id: string }>();
            const navigate = useNavigate();
            const { state, dispatch } = useAppContext();
            const { categories, currentUser } = state;
            
            const isEditing = Boolean(id);
            const recipeToEdit = useMemo(() => isEditing ? state.recipes.find(r => r.id === id) : null, [id, isEditing, state.recipes]);

            const [title, setTitle] = useState('');
            const [prepTimeInMinutes, setPrepTime] = useState(30);
            const [ingredients, setIngredients] = useState<Ingredient[]>([{ id: `ing-${Date.now()}`, name: '' }]);
            const [instructions, setInstructions] = useState('');
            const [notes, setNotes] = useState('');
            const [selectedCategories, setSelectedCategories] = useState<string[]>([]);
            const [imageUrls, setImageUrls] = useState<string[]>([]);

            useEffect(() => {
                if (isEditing && recipeToEdit) {
                    setTitle(recipeToEdit.title);
                    setPrepTime(recipeToEdit.prepTimeInMinutes);
                    setIngredients(recipeToEdit.ingredients);
                    setInstructions(recipeToEdit.instructions);
                    setNotes(recipeToEdit.notes || '');
                    setSelectedCategories(recipeToEdit.categories);
                    setImageUrls(recipeToEdit.imageUrls);
                }
            }, [isEditing, recipeToEdit]);

            const handleCategoryChange = (catId: string) => {
                setSelectedCategories(prev => 
                    prev.includes(catId) ? prev.filter(id => id !== catId) : [...prev, catId]
                );
            };

            const handleIngredientChange = (index: number, value: string) => {
                const newIngredients = [...ingredients];
                newIngredients[index].name = value;
                setIngredients(newIngredients);
            };

            const addIngredient = () => {
                setIngredients([...ingredients, { id: `ing-${Date.now()}`, name: '' }]);
            };
            
            const removeIngredient = (index: number) => {
                setIngredients(ingredients.filter((_, i) => i !== index));
            };

            const moveIngredient = (index: number, direction: 'up' | 'down') => {
                if ((direction === 'up' && index === 0) || (direction === 'down' && index === ingredients.length - 1)) return;
                const newIngredients = [...ingredients];
                const item = newIngredients.splice(index, 1)[0];
                newIngredients.splice(index + (direction === 'down' ? 1 : -1), 0, item);
                setIngredients(newIngredients);
            };
            
            const handleImageUpload = (e: ChangeEvent<HTMLInputElement>) => {
                if (e.target.files) {
                    const files = Array.from(e.target.files);
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            if (reader.result) {
                                setImageUrls(prev => [...prev, reader.result as string]);
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
            };
            
            const removeImage = (index: number) => {
                setImageUrls(prev => prev.filter((_, i) => i !== index));
            };

            const handleSubmit = (e: FormEvent) => {
                e.preventDefault();
                if (!currentUser) {
                    alert("Du skal være logget ind for at gemme en opskrift.");
                    return;
                }

                const recipeData: Recipe = {
                    id: isEditing && recipeToEdit ? recipeToEdit.id : `recipe-${Date.now()}`,
                    title,
                    imageUrls: imageUrls.length > 0 ? imageUrls : ['https://picsum.photos/seed/default/600/400'],
                    prepTimeInMinutes: Number(prepTimeInMinutes),
                    ingredients: ingredients.filter(i => i.name.trim() !== ''),
                    instructions,
                    notes,
                    categories: selectedCategories,
                    ratings: isEditing && recipeToEdit ? recipeToEdit.ratings : [],
                    authorId: isEditing && recipeToEdit ? recipeToEdit.authorId : currentUser.id,
                    createdAt: isEditing && recipeToEdit ? recipeToEdit.createdAt : new Date().toISOString(),
                };

                dispatch({ type: isEditing ? 'UPDATE_RECIPE' : 'ADD_RECIPE', payload: recipeData });
                navigate(`/recipe/${recipeData.id}`);
            };

            return (
                <div className="max-w-3xl mx-auto p-4 sm:p-6">
                    <h1 className="text-3xl font-bold mb-6 text-white">{isEditing ? 'Rediger Opskrift' : 'Opret Opskrift'}</h1>
                    <form onSubmit={handleSubmit} className="space-y-8">
                        <div className="space-y-2">
                            <label htmlFor="title" className="block text-lg font-medium text-[#75fb9e]">Titel</label>
                            <input type="text" id="title" value={title} onChange={e => setTitle(e.target.value)} required className="w-full bg-[#1a3e44] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"/>
                        </div>

                        <div className="space-y-2">
                             <label className="block text-lg font-medium text-[#75fb9e]">Billeder</label>
                             <div className="grid grid-cols-3 gap-4 mb-2">
                                {imageUrls.map((url, index) => (
                                   <div key={index} className="relative group">
                                     <img src={url} alt={`Preview ${index}`} className="w-full h-32 object-cover rounded-md"/>
                                     <button type="button" onClick={() => removeImage(index)} className="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <TrashIcon className="w-4 h-4" />
                                     </button>
                                   </div>
                                ))}
                             </div>
                             <input type="file" onChange={handleImageUpload} multiple accept="image/*" className="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#75fb9e] file:text-[#0f2d32] hover:file:bg-white"/>
                        </div>

                        <div className="space-y-2">
                            <label htmlFor="prepTime" className="block text-lg font-medium text-[#75fb9e]">Arbejdstid (minutter)</label>
                            <input type="number" id="prepTime" value={prepTimeInMinutes} onChange={e => setPrepTime(Number(e.target.value))} required className="w-full bg-[#1a3e44] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"/>
                        </div>

                        <div className="space-y-2">
                            <h3 className="text-lg font-medium text-[#75fb9e]">Ingredienser</h3>
                            <div className="space-y-3">
                                {ingredients.map((ing, index) => (
                                    <div key={ing.id} className="flex items-center gap-2">
                                        <input type="text" value={ing.name} onChange={e => handleIngredientChange(index, e.target.value)} placeholder={`Ingrediens ${index + 1}`} className="flex-grow bg-[#1a3e44] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"/>
                                        <div className="flex flex-col">
                                            <button type="button" onClick={() => moveIngredient(index, 'up')} className="p-1 text-gray-400 hover:text-white" disabled={index === 0}><ArrowUpIcon className="w-5 h-5"/></button>
                                            <button type="button" onClick={() => moveIngredient(index, 'down')} className="p-1 text-gray-400 hover:text-white" disabled={index === ingredients.length - 1}><ArrowDownIcon className="w-5 h-5"/></button>
                                        </div>
                                        <button type="button" onClick={() => removeIngredient(index)} className="p-2 text-red-500 hover:text-red-400"><TrashIcon className="w-6 h-6"/></button>
                                    </div>
                                ))}
                            </div>
                            <button type="button" onClick={addIngredient} className="mt-2 flex items-center gap-2 text-[#75fb9e] font-semibold hover:text-white">
                                <PlusIcon className="w-5 h-5"/> Tilføj ingrediens
                            </button>
                        </div>
                        
                        <div className="space-y-2">
                            <label htmlFor="instructions" className="block text-lg font-medium text-[#75fb9e]">Fremgangsmåde</label>
                            <textarea id="instructions" value={instructions} onChange={e => setInstructions(e.target.value)} rows={8} required className="w-full bg-[#1a3e44] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"/>
                        </div>

                         <div className="space-y-2">
                            <label htmlFor="notes" className="block text-lg font-medium text-[#75fb9e]">Noter</label>
                            <textarea id="notes" value={notes} onChange={e => setNotes(e.target.value)} rows={3} className="w-full bg-[#1a3e44] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"/>
                        </div>

                        <div className="space-y-2">
                            <h3 className="text-lg font-medium text-[#75fb9e]">Kategorier</h3>
                            <div className="flex flex-wrap gap-3">
                                {categories.map(cat => (
                                    <div key={cat.id}>
                                        <input type="checkbox" id={`cat-${cat.id}`} checked={selectedCategories.includes(cat.id)} onChange={() => handleCategoryChange(cat.id)} className="hidden peer"/>
                                        <label htmlFor={`cat-${cat.id}`} className="block cursor-pointer p-2 px-4 rounded-full border border-gray-600 peer-checked:bg-[#75fb9e] peer-checked:text-[#0f2d32] peer-checked:border-[#75fb9e] transition-colors">{cat.name}</label>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-end gap-4">
                            <button type="button" onClick={() => navigate(-1)} className="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-500 transition-colors">Annuller</button>
                            <button type="submit" className="bg-[#75fb9e] text-[#0f2d32] font-bold py-3 px-6 rounded-lg hover:bg-white transition-colors">Gem Opskrift</button>
                        </div>
                    </form>
                </div>
            );
        };

        const UserPage = () => {
            const { id } = useParams<{ id: string }>();
            const { state } = useAppContext();
            const user = state.users.find(u => u.id === id);

            if (!user) {
                return <div className="p-8 text-center">Bruger ikke fundet. <Link to="/" className="text-[#75fb9e]">Gå til forsiden</Link></div>;
            }

            return (
                <div className="p-4 sm:p-6">
                    <div className="flex items-center gap-4 mb-6">
                        <img src={user.imageUrl} alt={user.name} className="w-24 h-24 rounded-full border-4 border-[#75fb9e]"/>
                        <div>
                            <h1 className="text-3xl font-bold text-white">{user.name}</h1>
                            <p className="text-gray-400">Favoritopskrifter</p>
                        </div>
                    </div>
                    <FindRecipePage mode="favorites" />
                </div>
            );
        };

        const AdminPage = () => {
            const { state, dispatch } = useAppContext();
            const [newUserName, setNewUserName] = useState('');
            const [newUserImage, setNewUserImage] = useState('');
            const [newCategoryName, setNewCategoryName] = useState('');
            
            const handleAddUser = (e: FormEvent) => {
                e.preventDefault();
                if (!newUserName.trim()) return;
                const newUser: User = {
                    id: `user-${Date.now()}`,
                    name: newUserName,
                    imageUrl: newUserImage || `https://picsum.photos/seed/${newUserName}/100/100`,
                    favoriteRecipeIds: [],
                };
                dispatch({ type: 'ADD_USER', payload: newUser });
                setNewUserName('');
                setNewUserImage('');
            };

            const handleAddCategory = (e: FormEvent) => {
                e.preventDefault();
                if (!newCategoryName.trim()) return;
                const newCategory: Category = {
                    id: `cat-${Date.now()}`,
                    name: newCategoryName,
                };
                dispatch({ type: 'ADD_CATEGORY', payload: newCategory });
                setNewCategoryName('');
            };
            
            const handleExport = () => {
                const dataStr = JSON.stringify(state, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'mad_app_data.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };
            
            const handleImport = (e: ChangeEvent<HTMLInputElement>) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const json = event.target?.result as string;
                        const importedState = JSON.parse(json);
                        // Simple validation
                        if (importedState.users && importedState.recipes && importedState.categories) {
                            dispatch({ type: 'LOAD_STATE', payload: importedState });
                            alert('Data importeret succesfuldt!');
                        } else {
                            throw new Error("Invalid file format");
                        }
                    } catch (err) {
                        alert('Fejl: Kunne ikke importere data. Filen er muligvis korrupt eller i forkert format.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="max-w-4xl mx-auto p-6">
                    <h1 className="text-4xl font-bold mb-8 text-[#75fb9e]">Admin Panel</h1>
                    <div className="grid md:grid-cols-2 gap-8">
                        {/* User Management */}
                        <div className="bg-[#1a3e44] p-6 rounded-lg">
                            <h2 className="text-2xl font-semibold mb-4 text-white">Brugere</h2>
                            <form onSubmit={handleAddUser} className="flex gap-2 mb-4">
                                <input type="text" value={newUserName} onChange={e => setNewUserName(e.target.value)} placeholder="Brugernavn" className="flex-grow bg-[#0f2d32] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"/>
                                <button type="submit" className="bg-[#75fb9e] text-[#0f2d32] font-bold px-4 rounded-md hover:bg-white transition-colors">Opret</button>
                            </form>
                            <ul className="space-y-2">
                                {state.users.map(user => (
                                    <li key={user.id} className="flex items-center justify-between bg-[#0f2d32] p-2 rounded">
                                        <div className="flex items-center gap-2">
                                            <img src={user.imageUrl} alt={user.name} className="w-8 h-8 rounded-full"/>
                                            <span>{user.name}</span>
                                        </div>
                                        <button onClick={() => dispatch({type: 'DELETE_USER', payload: user.id})} className="text-red-500 hover:text-red-400"><TrashIcon className="w-5 h-5"/></button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        {/* Category Management */}
                        <div className="bg-[#1a3e44] p-6 rounded-lg">
                            <h2 className="text-2xl font-semibold mb-4 text-white">Kategorier</h2>
                            <form onSubmit={handleAddCategory} className="flex gap-2 mb-4">
                                <input type="text" value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} placeholder="Kategorinavn" className="flex-grow bg-[#0f2d32] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-[#75fb9e] focus:outline-none"/>
                                <button type="submit" className="bg-[#75fb9e] text-[#0f2d32] font-bold px-4 rounded-md hover:bg-white transition-colors">Opret</button>
                            </form>
                             <ul className="space-y-2">
                                {state.categories.map(cat => (
                                    <li key={cat.id} className="flex items-center justify-between bg-[#0f2d32] p-2 rounded">
                                        <span>{cat.name}</span>
                                        <button onClick={() => dispatch({type: 'DELETE_CATEGORY', payload: cat.id})} className="text-red-500 hover:text-red-400"><TrashIcon className="w-5 h-5"/></button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        {/* Data Management */}
                        <div className="md:col-span-2 bg-[#1a3e44] p-6 rounded-lg">
                            <h2 className="text-2xl font-semibold mb-4 text-white">Data Management (Google Drev)</h2>
                            <p className="text-gray-400 mb-4">Eksporter data for at gemme en backup, f.eks. i en delt Google Drev mappe. Importer for at gendanne.</p>
                            <div className="flex gap-4">
                               <button onClick={handleExport} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-500">Eksporter Data</button>
                               <label className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-500 cursor-pointer">
                                   Importer Data
                                   <input type="file" accept=".json" onChange={handleImport} className="hidden"/>
                               </label>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        function App() {
          const location = useLocation();
          const isAdminPage = location.pathname.startsWith('/admin');

          return (
            <>
              {!isAdminPage && <UserSelectionHeader />}
              <main className={isAdminPage ? '' : 'pt-4'}>
                <Routes>
                  <Route path="/" element={<WelcomePage />} />
                  <Route path="/recipes" element={<FindRecipePage />} />
                  <Route path="/recipe/:id" element={<RecipeDetailPage />} />
                  <Route path="/create" element={<RecipeFormPage />} />
                  <Route path="/edit/:id" element={<RecipeFormPage />} />
                  <Route path="/user/:id" element={<UserPage />} />
                  <Route path="/admin" element={<AdminPage />} />
                </Routes>
              </main>
            </>
          );
        }

        const AppWrapper = () => (
            <HashRouter>
                <App/>
            </HashRouter>
        );

        // --- APP INITIALIZATION --- //
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <AppProvider>
                <AppWrapper />
            </AppProvider>
          </React.StrictMode>
        );
    </script>
</body>
</html>
